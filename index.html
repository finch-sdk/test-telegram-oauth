<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram OAuth</title>
</head>
<body>
    <h1>Telegram OAuth</h1>
    <div id="content">
        <p>Loading...</p>
    </div>

    <script>
        const contentEl = document.getElementById('content');
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const botUsername = params.get('bot');
        const callbackBase = params.get('cb');

        function getAuthDataFromQuery() {
            const p = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of p.entries()) {
                if (key === 'bot' || key === 'cb') continue;
                result[key] = value;
            }
            return Object.keys(result).length > 0 ? result : null;
        }

        const authData = getAuthDataFromQuery();

        if (authData && authData.id && authData.hash) {
            const callbackUrl = callbackBase + '?' + new URLSearchParams(authData).toString();
            console.log('[Telegram OAuth] Redirecting to app:', callbackUrl);
            window.location.href = callbackUrl;
            contentEl.innerHTML = '<p>Authorization successful. Redirecting to app...</p>';
        } else {
            contentEl.innerHTML = '<p>Please login with Telegram:</p><div id="tg-login"></div>';
            const script = document.createElement('script');
            script.async = true;
            script.src = "https://telegram.org/js/telegram-widget.js?22";
            script.setAttribute('data-telegram-login', botUsername);
            script.setAttribute('data-size', 'large');
            const authUrl = url.origin + url.pathname
                + '?bot=' + encodeURIComponent(botUsername)
                + '&cb=' + encodeURIComponent(callbackBase);
            script.setAttribute('data-auth-url', authUrl);
            script.setAttribute('data-request-access', 'write');
            document.getElementById('tg-login').appendChild(script);
        }
    </script>
</body>
</html>