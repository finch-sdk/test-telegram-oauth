<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram OAuth</title>
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            padding-top: 48px;
        }
        #content {
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <h1>Telegram OAuth</h1>
    <div id="content">
        <p>Loading...</p>
    </div>
    <script>
        const contentEl = document.getElementById('content');
        const url = new URL(window.location.href);
        const params = url.searchParams;
        
        // 从 URL hash fragment 解析 bot 和 cb（Telegram widget 不会替换 hash）
        let botUsername = null;
        let callbackBase = null;
        
        // 首先尝试从 URL 查询参数获取
        if (params.get('bot') && params.get('cb')) {
            botUsername = params.get('bot');
            callbackBase = params.get('cb');
            // 保存到 hash fragment，这样 Telegram widget 回调时不会丢失
            window.location.hash = 'bot=' + encodeURIComponent(botUsername) + '&cb=' + encodeURIComponent(callbackBase);
        } else if (window.location.hash) {
            // 从 hash fragment 获取
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            botUsername = hashParams.get('bot');
            callbackBase = hashParams.get('cb');
        }
        
        // 如果还是没有，尝试从 storage 获取（作为最后的备选）
        if (!botUsername || !callbackBase) {
            try {
                botUsername = botUsername || sessionStorage.getItem('tg_bot') || localStorage.getItem('tg_bot');
                callbackBase = callbackBase || sessionStorage.getItem('tg_cb') || localStorage.getItem('tg_cb');
            } catch (e) {
                // Storage 不可用
            }
        }
        
        // 如果 URL 查询参数中有 bot 和 cb，也保存到 storage（作为备选）
        let storageSaveResult = 'not saved';
        if (params.get('bot') && params.get('cb')) {
            try {
                sessionStorage.setItem('tg_bot', params.get('bot'));
                sessionStorage.setItem('tg_cb', params.get('cb'));
                localStorage.setItem('tg_bot', params.get('bot'));
                localStorage.setItem('tg_cb', params.get('cb'));
                storageSaveResult = 'saved to storage';
            } catch (e) {
                storageSaveResult = 'storage not available';
            }
        }
        
        // 调试信息显示在页面上
        function showDebugInfo() {
            const debugInfo = `
                <div style="text-align: left; margin: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">
                    <strong>Debug Info:</strong><br>
                    URL: ${window.location.href}<br>
                    Hash: ${window.location.hash || '(empty)'}<br>
                    botUsername: ${botUsername || '(empty)'}<br>
                    callbackBase: ${callbackBase || '(empty)'}<br>
                    All params: ${JSON.stringify(Array.from(params.entries()))}<br>
                    Storage save result: ${storageSaveResult}<br>
                    From sessionStorage: bot=${sessionStorage.getItem('tg_bot') || '(empty)'}, cb=${sessionStorage.getItem('tg_cb') || '(empty)'}<br>
                    From localStorage: bot=${localStorage.getItem('tg_bot') || '(empty)'}, cb=${localStorage.getItem('tg_cb') || '(empty)'}
                </div>
            `;
            return debugInfo;
        }

        function getAuthDataFromQuery() {
            const p = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of p.entries()) {
                if (key === 'bot' || key === 'cb') continue;
                result[key] = value;
            }
            return Object.keys(result).length > 0 ? result : null;
        }

        function handleAuthCallback(authData) {
            if (!authData || !authData.id || !authData.hash || !callbackBase) {
                return false;
            }
            // 清除 sessionStorage 和 localStorage
            try {
                sessionStorage.removeItem('tg_bot');
                sessionStorage.removeItem('tg_cb');
                localStorage.removeItem('tg_bot');
                localStorage.removeItem('tg_cb');
            } catch (e) {
                console.error('Failed to clear storage:', e);
            }
            const callbackUrl = callbackBase + '?' + new URLSearchParams(authData).toString();
            contentEl.innerHTML = '<p>Authorization successful. Redirecting...</p>';
            window.location.href = callbackUrl;
            return true;
        }

        function showWidgetLogin() {
            if (!botUsername || !callbackBase) {
                contentEl.innerHTML = showDebugInfo() + '<p style="color: red;">Telegram configuration error. Please contact support.</p>';
                return;
            }
            contentEl.innerHTML = showDebugInfo() + '<p>Please login with Telegram:</p><div id="tg-login"></div>';
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://telegram.org/js/telegram-widget.js?22';
            script.setAttribute('data-telegram-login', botUsername);
            script.setAttribute('data-size', 'large');
            // 构建 auth-url，同时使用查询参数和 hash fragment
            // 查询参数：Telegram widget 可能会替换，但先尝试
            // Hash fragment：作为备选，Telegram widget 不会替换
            const authUrl = url.origin + url.pathname
                + '?bot=' + encodeURIComponent(botUsername || '')
                + '&cb=' + encodeURIComponent(callbackBase || '')
                + '#bot=' + encodeURIComponent(botUsername || '')
                + '&cb=' + encodeURIComponent(callbackBase || '');
            script.setAttribute('data-auth-url', authUrl);
            console.log('Setting data-auth-url:', authUrl);
            script.setAttribute('data-request-access', 'write');
            document.getElementById('tg-login').appendChild(script);
        }
        const authData = getAuthDataFromQuery();
        if (!handleAuthCallback(authData)) {
            showWidgetLogin();
        }
    </script>
</body>
</html>