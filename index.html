<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram OAuth</title>
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            padding-top: 48px;
        }
        #content {
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <h1>Telegram OAuth</h1>
    <div id="content">
        <p>Loading...</p>
    </div>
    <script>
        const contentEl = document.getElementById('content');
        const url = new URL(window.location.href);
        const params = url.searchParams;
        
        // 辅助函数：设置 cookie
        function setCookie(name, value, days = 1) {
            const expires = new Date();
            expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
            document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/';
        }
        
        // 辅助函数：获取 cookie
        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
            }
            return null;
        }
        
        // 从 URL 查询参数获取 bot 和 cb
        // 注意：cb 参数可能包含 bot 和最终的 callbackBase，需要解析
        let botUsername = params.get('bot');
        let callbackBase = params.get('cb');
        let finalCallbackBase = callbackBase; // 最终的 callbackBase（用于重定向到 Android app）
        
        // 如果 cb 参数存在，尝试从中解析 bot 和最终的 callbackBase
        if (callbackBase) {
            try {
                const cbUrl = new URL(callbackBase);
                const cbParams = cbUrl.searchParams;
                // 如果 cb 参数中包含 bot，使用它
                if (cbParams.get('bot')) {
                    botUsername = cbParams.get('bot');
                }
                // 如果 cb 参数中包含嵌套的 cb，提取最终的 callbackBase
                if (cbParams.get('cb')) {
                    finalCallbackBase = cbParams.get('cb');
                } else {
                    // 否则，使用 cb 参数的 base URL（移除查询参数）
                    finalCallbackBase = cbUrl.origin + cbUrl.pathname;
                }
            } catch (e) {
                // cb 不是有效的 URL，使用原始值
                finalCallbackBase = callbackBase;
            }
        }
        
        // 如果还是没有，尝试从 cookie 获取（作为备选）
        if (!botUsername || !callbackBase) {
            botUsername = botUsername || getCookie('tg_bot');
            callbackBase = callbackBase || getCookie('tg_cb');
        }
        
        // 如果 URL 中有 bot 和 cb 参数，保存到 cookie（作为备选）
        let saveResult = 'not saved';
        if (params.get('bot') && params.get('cb')) {
            try {
                setCookie('tg_bot', params.get('bot'));
                setCookie('tg_cb', params.get('cb'));
                saveResult = 'saved to cookie';
            } catch (e) {
                saveResult = 'cookie save failed: ' + e.message;
            }
        }
        
        // 如果还是没有，尝试从 storage 获取（作为最后的备选）
        if (!botUsername || !callbackBase) {
            try {
                botUsername = botUsername || sessionStorage.getItem('tg_bot') || localStorage.getItem('tg_bot');
                callbackBase = callbackBase || sessionStorage.getItem('tg_cb') || localStorage.getItem('tg_cb');
                if (botUsername && callbackBase) {
                    saveResult = 'loaded from storage';
                }
            } catch (e) {
                // Storage 不可用
            }
        }
        
        // 调试信息显示在页面上
        function showDebugInfo() {
            const debugInfo = `
                <div style="text-align: left; margin: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 12px;">
                    <strong>Debug Info:</strong><br>
                    URL: ${window.location.href}<br>
                    botUsername: ${botUsername || '(empty)'}<br>
                    callbackBase (from URL): ${callbackBase || '(empty)'}<br>
                    finalCallbackBase (for redirect): ${finalCallbackBase || '(empty)'}<br>
                    All params: ${JSON.stringify(Array.from(params.entries()))}<br>
                    Save/Load result: ${saveResult}<br>
                    From cookie: bot=${getCookie('tg_bot') || '(empty)'}, cb=${getCookie('tg_cb') || '(empty)'}<br>
                    From sessionStorage: bot=${sessionStorage.getItem('tg_bot') || '(empty)'}, cb=${sessionStorage.getItem('tg_cb') || '(empty)'}<br>
                    From localStorage: bot=${localStorage.getItem('tg_bot') || '(empty)'}, cb=${localStorage.getItem('tg_cb') || '(empty)'}
                </div>
            `;
            return debugInfo;
        }

        function getAuthDataFromQuery() {
            const p = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of p.entries()) {
                if (key === 'bot' || key === 'cb') continue;
                result[key] = value;
            }
            return Object.keys(result).length > 0 ? result : null;
        }

        function handleAuthCallback(authData) {
            if (!authData || !authData.id || !authData.hash || !finalCallbackBase) {
                return false;
            }
            // 清除 cookie、sessionStorage 和 localStorage
            try {
                setCookie('tg_bot', '', -1); // 删除 cookie
                setCookie('tg_cb', '', -1);
                sessionStorage.removeItem('tg_bot');
                sessionStorage.removeItem('tg_cb');
                localStorage.removeItem('tg_bot');
                localStorage.removeItem('tg_cb');
            } catch (e) {
                console.error('Failed to clear storage:', e);
            }
            const callbackUrl = finalCallbackBase + '?' + new URLSearchParams(authData).toString();
            contentEl.innerHTML = '<p>Authorization successful. Redirecting...</p>';
            window.location.href = callbackUrl;
            return true;
        }

        function showWidgetLogin() {
            if (!botUsername || !callbackBase) {
                contentEl.innerHTML = showDebugInfo() + '<p style="color: red;">Telegram configuration error. Please contact support.</p>';
                return;
            }
            contentEl.innerHTML = showDebugInfo() + '<p>Please login with Telegram:</p><div id="tg-login"></div>';
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://telegram.org/js/telegram-widget.js?22';
            script.setAttribute('data-telegram-login', botUsername);
            script.setAttribute('data-size', 'large');
            // 构建 auth-url（Telegram widget 会完全替换 URL，所以参数会丢失）
            // 但我们已经将 bot 和 cb 保存到 cookie，所以回调时可以从 cookie 读取
            const authUrl = url.origin + url.pathname;
            script.setAttribute('data-auth-url', authUrl);
            console.log('Setting data-auth-url:', authUrl);
            script.setAttribute('data-request-access', 'write');
            document.getElementById('tg-login').appendChild(script);
        }
        const authData = getAuthDataFromQuery();
        if (!handleAuthCallback(authData)) {
            showWidgetLogin();
        }
    </script>
</body>
</html>